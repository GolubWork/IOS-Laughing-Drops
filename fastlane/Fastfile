lane :build do
  UI.message "üöÄ BUILD STARTED"

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI
  setup_ci
  sync_certificates

  # –û—á–∏—Å—Ç–∫–∞
  UI.message "üßπ Cleaning DerivedData and Pods..."
  sh("rm -rf ~/Library/Developer/Xcode/DerivedData")
  sh("rm -rf Pods")
  sh("rm -rf Podfile.lock")
  cocoapods(clean_install: true)

  ENV["SWIFT_OPTIMIZATION_LEVEL"] = "-Onone"

  # Xcode info
  UI.message "üõ†Ô∏è Xcode path: #{`xcode-select -p`.strip}"
  UI.message "üõ†Ô∏è Xcode version: #{`xcodebuild -version`.strip}"

  # Paths
  repo_root = File.expand_path("..", __dir__)
  workspace_path = Dir[File.join(repo_root, "**/*.xcworkspace")].reject { |p| p.include?(".xcodeproj/") }.first
  project_path   = Dir[File.join(repo_root, "**/*.xcodeproj")].first if workspace_path.nil?
  scheme         = ENV["IOS_SCHEME"] || ENV["PROJECT_NAME"]

  UI.message "üìå workspace_path=#{workspace_path}, project_path=#{project_path}, scheme=#{scheme}"

  # Auto increment build number
  main_bundle = ENV["IOS_BUNDLE_ID"]
  ci_build = ENV["BUILD_NUMBER"].to_i
  latest_store_build = app_store_build_number(app_identifier: main_bundle) rescue 0
  next_build = [latest_store_build + 1, ci_build, 1].max
  increment_build_number(xcodeproj: project_path, build_number: next_build)
  set_info_plist_value(path: "LaughingDrops/LaughingDrops/GoogleService-Info.plist", key: "CFBundleVersion", value: next_build.to_s) rescue nil

  # Build
  UI.message "üèóÔ∏è Starting build_app..."
  build_app(
    workspace: workspace_path,
    scheme: scheme,
    configuration: "Release",
    clean: true,
    export_method: "app-store",
    verbose: true,
    build_path: "./build",
    xcargs: "ONLY_ACTIVE_ARCH=NO ENABLE_BITCODE=NO -showBuildTimingSummary"
  )

  UI.message "‚úÖ build_app finished"

  # Upload
  ipa_output_dir = File.join(repo_root, "build/iOS/ipa_out")
  ipa_path = Dir[File.join(ipa_output_dir, "*.ipa")].first
  UI.user_error!("‚ùå IPA –Ω–µ –Ω–∞–π–¥–µ–Ω!") if ipa_path.nil?

  if ENV["UPLOAD_TO_TESTFLIGHT"] == "1" || ENV["UPLOAD_CHANNEL"] == "beta"
    UI.message "üöÄ Uploading to TestFlight"
    upload_to_testflight(ipa: ipa_path, skip_waiting_for_build_processing: true, changelog: ENV["CHANGELOG"] || "Auto-upload from CI")
  else
    UI.message "üöÄ Uploading to App Store"
    upload_to_app_store(
      ipa: ipa_path,
      submit_for_review: false,
      automatic_release: false,
      force: true,
      skip_screenshots: true,
      skip_metadata: true,
      run_precheck_before_submit: false,
      app_identifier: main_bundle
    )
  end

  UI.success("üéâ –ë–∏–ª–¥ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ App Store Connect!")
end
